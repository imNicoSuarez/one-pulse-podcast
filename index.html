<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Podcast</title>
    <!-- Carga de Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración de fuente Inter para una apariencia limpia */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para asegurar que la imagen de portada se vea bien */
        .podcast-cover {
            width: 100px;
            height: 100px;
            object-fit: cover;
        }
        /* Estilo para la imagen del episodio en el reproductor */
        .player-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Ocultar los controles de audio nativos en algunos navegadores si se usan controles personalizados, aunque aquí usamos los nativos */
        #audio-player::-webkit-media-controls-enclosure {
            border-radius: 0.75rem;
        }
    </style>
    <script>
        // Configuración de Tailwind para usar el color principal
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4F46E5', // Indigo 600
                        'secondary': '#1F2937', // Gray 800
                    }
                }
            }
        }

        // --- Lógica del Reproductor de Podcast ---
        
        // Variables globales para elementos del DOM
        let rssInput;
        let episodesList;
        let audioPlayer;
        let loadingMessage;
        let audioErrorContainer;
        let podcastCoverDisplay;
        let playerImageContainer;
        let defaultPodcastCoverUrl = 'https://placehold.co/100x100/4F46E5/FFFFFF?text=Podcast'; // Placeholder por defecto
        
        // Constante para el espacio de nombres de iTunes
        const ITUNES_NAMESPACE = 'http://www.itunes.com/dtds/podcast-1.0.dtd';
        
        /**
         * Inicializa la aplicación después de que el DOM esté completamente cargado.
         */
        window.onload = function() {
            rssInput = document.getElementById('rss-url');
            episodesList = document.getElementById('episodes-list');
            audioPlayer = document.getElementById('audio-player');
            loadingMessage = document.getElementById('loading-message');
            audioErrorContainer = document.getElementById('audio-error-container');
            podcastCoverDisplay = document.getElementById('podcast-cover-display');
            playerImageContainer = document.getElementById('player-image-container');

            // Agrega el manejador de errores al reproductor de audio
            audioPlayer.addEventListener('error', handleAudioError);

            // Establecer el feed del usuario como valor por defecto
            rssInput.value = 'https://imnicosuarez.github.io/one-pulse-podcast/mini-tertulias-y-cafe/rss.xml'; 

            // Asignar el evento al botón de carga
            document.getElementById('load-button').addEventListener('click', () => {
                const url = rssInput.value.trim();
                if (url) {
                    loadFeed(url);
                }
            });

            // Establecer la imagen de portada por defecto al inicio
            podcastCoverDisplay.src = defaultPodcastCoverUrl;
        }

        /**
         * Muestra mensajes de estado (ej: cargando, error).
         * @param {string} text - El mensaje a mostrar.
         * @param {string} type - 'loading', 'error', o 'success'.
         */
        function showMessage(text, type = 'loading') {
            loadingMessage.textContent = text;
            loadingMessage.className = 'p-4 rounded-lg mt-6 text-center transition-all duration-300';
            
            if (type === 'loading') {
                loadingMessage.classList.add('bg-indigo-100', 'text-primary');
            } else if (type === 'error') {
                loadingMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                loadingMessage.classList.add('hidden');
            }
            loadingMessage.classList.remove('hidden');
        }

        /**
         * Maneja los errores del reproductor de audio, a menudo causados por URLs no válidas o CORS.
         */
        function handleAudioError(e) {
            let errorText = 'Error de reproducción. Puede deberse a un formato incompatible, error de red o un enlace que no es de streaming.';

            // Intenta obtener un código de error más específico
            if (e.target.error) {
                switch (e.target.error.code) {
                    case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorText = 'La URL de audio no es compatible para la transmisión (streaming). Por favor, asegúrate de que sea un archivo de audio directo (.mp3, .m4a) y no un enlace de descarga (como Google Drive).';
                        break;
                    case e.target.error.MEDIA_ERR_NETWORK:
                        errorText = 'Error de red al intentar cargar el audio. Verifica tu conexión.';
                        break;
                    case e.target.error.MEDIA_ERR_DECODE:
                        errorText = 'El audio no pudo decodificarse o el formato no es compatible con tu navegador.';
                        break;
                    case e.target.error.MEDIA_ERR_ABORTED:
                        // Abortado puede ocurrir al cambiar de episodio. No es un error de URL.
                        return; 
                    default:
                        // Usar el mensaje genérico
                }
            }
            
            // Mostrar el mensaje de error de audio en el contenedor
            audioErrorContainer.textContent = `🚫 ${errorText}`;
            audioErrorContainer.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'p-4', 'rounded-lg', 'mt-4');
            audioErrorContainer.classList.add('bg-red-100', 'text-red-700', 'p-4', 'rounded-lg', 'mt-4');
            
            // Ocultar el mensaje después de 8 segundos
            setTimeout(() => {
                audioErrorContainer.classList.add('hidden');
            }, 8000);
        }

        /**
         * Carga y parsea el feed RSS desde la URL proporcionada.
         * @param {string} url - La URL del feed RSS.
         */
        async function loadFeed(url) {
            episodesList.innerHTML = '';
            audioPlayer.src = '';
            audioErrorContainer.classList.add('hidden'); // Ocultar errores previos de audio
            playerImageContainer.innerHTML = `<img src="${defaultPodcastCoverUrl}" class="player-cover opacity-50" alt="Placeholder">`;
            showMessage('Cargando episodios...', 'loading');

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error de red: ${response.status} ${response.statusText}`);
                }
                const xmlText = await response.text();
                parseXML(xmlText);
                showMessage('', 'success'); // Ocultar mensaje de carga
            } catch (error) {
                console.error('Error al cargar el feed:', error);
                showMessage(`Error al cargar el feed. Verifica la URL y las restricciones de CORS. Mensaje: ${error.message}`, 'error');
                // Restablecer el título del podcast
                document.getElementById('podcast-title-display').textContent = 'Error al Cargar';
                podcastCoverDisplay.src = defaultPodcastCoverUrl;
            }
        }

        /**
         * Parsea el texto XML y renderiza la lista de episodios.
         * @param {string} xmlText - El contenido XML del feed.
         */
        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // 1. Obtener el título del podcast
            const channelTitleElement = xmlDoc.querySelector('channel > title');
            const podcastTitle = channelTitleElement ? channelTitleElement.textContent : 'Podcast Desconocido';
            document.getElementById('podcast-title-display').textContent = podcastTitle;
            
            // 2. Obtener la imagen de portada del podcast (Channel Image)
            let podcastImageUrl = defaultPodcastCoverUrl;
            
            // 2.1 Buscar en <itunes:image> (Usando getElementsByTagNameNS para mayor compatibilidad)
            // Esto busca la etiqueta 'image' con el namespace de iTunes
            const itunesImageElements = xmlDoc.getElementsByTagNameNS(ITUNES_NAMESPACE, 'image');
            const channelItunesImage = itunesImageElements.length > 0 ? itunesImageElements[0] : null;

            if (channelItunesImage && channelItunesImage.getAttribute('href')) {
                podcastImageUrl = channelItunesImage.getAttribute('href');
            } else {
                // 2.2 Buscar en <image> standard
                const standardImage = xmlDoc.querySelector('channel > image > url');
                if (standardImage && standardImage.textContent) {
                    podcastImageUrl = standardImage.textContent;
                }
            }
            
            podcastCoverDisplay.src = podcastImageUrl;
            // Asegurarse de que la imagen del reproductor también se actualice con la portada del podcast (como fallback inicial)
            playerImageContainer.innerHTML = `<img src="${podcastImageUrl}" class="player-cover opacity-50" alt="Cover Podcast">`;


            // 3. Obtener los elementos de los episodios
            const items = xmlDoc.querySelectorAll('item');

            if (items.length === 0) {
                showMessage('No se encontraron episodios en este feed. Asegúrate de que la URL es correcta.', 'error');
                return;
            }

            episodesList.innerHTML = ''; // Limpiar la lista antes de añadir nuevos

            items.forEach(item => {
                const title = item.querySelector('title')?.textContent || 'Título Desconocido';
                const description = item.querySelector('description')?.textContent || 'Sin descripción.';
                const pubDate = item.querySelector('pubDate')?.textContent || '';
                
                // Buscar la URL del audio en la etiqueta <enclosure>
                const enclosure = item.querySelector('enclosure');
                const audioUrl = enclosure ? enclosure.getAttribute('url') : null;

                // Buscar la imagen del episodio (priorizar itunes:image a nivel de item)
                let episodeImageUrl = podcastImageUrl; // Usar la imagen del podcast como fallback
                
                // Usar getElementsByTagNameNS para encontrar itunes:image dentro del item
                const itemItunesImageElements = item.getElementsByTagNameNS(ITUNES_NAMESPACE, 'image');
                const itemItunesImage = itemItunesImageElements.length > 0 ? itemItunesImageElements[0] : null;
                
                if (itemItunesImage && itemItunesImage.getAttribute('href')) {
                    episodeImageUrl = itemItunesImage.getAttribute('href');
                }

                if (audioUrl) {
                    const episodeElement = createEpisodeElement(title, description, pubDate, audioUrl, episodeImageUrl);
                    episodesList.appendChild(episodeElement);
                }
            });

            if (episodesList.children.length === 0) {
                 showMessage('No se encontraron archivos de audio válidos (etiquetas <enclosure>) en este feed.', 'error');
            }
        }

        /**
         * Crea el elemento HTML para un episodio individual.
         */
        function createEpisodeElement(title, description, pubDate, audioUrl, imageUrl) {
            // Formatear la fecha
            let formattedDate = '';
            if (pubDate) {
                try {
                    formattedDate = new Date(pubDate).toLocaleDateString('es-ES', { 
                        year: 'numeric', month: 'short', day: 'numeric' 
                    });
                } catch (e) {
                    formattedDate = pubDate; // Usar el texto original si el parseo falla
                }
            }

            // Crear el contenedor principal del episodio
            const episodeDiv = document.createElement('div');
            // Añadir flex y alineación para la imagen
            episodeDiv.className = 'p-4 md:p-6 bg-white border border-gray-200 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex items-center space-x-4';
            
            // Contenedor de la imagen del episodio
            const imageContainer = document.createElement('div');
            imageContainer.className = 'flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden hidden sm:block';
            imageContainer.innerHTML = `<img src="${imageUrl}" onerror="this.onerror=null;this.src='${defaultPodcastCoverUrl}';" class="w-full h-full object-cover" alt="Cover ${title}">`;

            // Contenido del episodio (Título, Fecha, Descripción)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'sm:flex-grow min-w-0';
            contentDiv.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 truncate">${title}</h3>
                ${formattedDate ? `<p class="text-xs text-primary font-medium mt-1">${formattedDate}</p>` : ''}
                <p class="text-gray-600 mt-2 text-sm line-clamp-2">${description.replace(/<[^>]*>?/gm, '')}</p>
            `;

            // Botón de reproducción y contenedor
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex-shrink-0 ml-auto';
            
            const playButton = document.createElement('button');
            playButton.textContent = 'Reproducir';
            playButton.className = 'px-4 py-2 bg-primary text-white font-bold rounded-full text-sm shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50 transition duration-150 whitespace-nowrap';
            playButton.addEventListener('click', () => playEpisode(title, audioUrl, imageUrl));
            
            controlsDiv.appendChild(playButton);

            episodeDiv.appendChild(imageContainer);
            episodeDiv.appendChild(contentDiv);
            episodeDiv.appendChild(controlsDiv);

            return episodeDiv;
        }

        /**
         * Carga el audio del episodio en el reproductor y lo inicia.
         * @param {string} title - El título del episodio para mostrar.
         * @param {string} audioUrl - La URL del archivo de audio.
         * @param {string} imageUrl - La URL de la imagen del episodio.
         */
        function playEpisode(title, audioUrl, imageUrl) {
            // 1. Ocultar cualquier error anterior
            audioErrorContainer.classList.add('hidden');
            
            // 2. Actualizar la imagen del reproductor
            playerImageContainer.innerHTML = `<img src="${imageUrl}" onerror="this.onerror=null;this.src='${defaultPodcastCoverUrl}';" class="player-cover" alt="Cover ${title}">`;

            // 3. Cargar y reproducir audio
            audioPlayer.src = audioUrl;
            audioPlayer.title = title;
            document.getElementById('playing-title').textContent = title;
            document.getElementById('playing-source').textContent = `Fuente: ${audioUrl.substring(0, 40)}...`;

            // 4. Intentar reproducir automáticamente
            const playPromise = audioPlayer.play();

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    // Reproducción iniciada
                }).catch(error => {
                    console.warn("La reproducción automática fue bloqueada. El usuario debe presionar 'Play' en el control.");
                });
            }
        }

    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center py-6 mb-8 border-b-2 border-primary/10">
            <h1 class="text-4xl font-extrabold text-primary">Reproductor de Podcast RSS</h1>
            <p class="text-gray-600 mt-2">Carga cualquier *feed* RSS de podcast para escuchar tus episodios favoritos.</p>
        </header>

        <!-- Sección de Entrada de URL -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="url" 
                    id="rss-url" 
                    placeholder="URL del Feed RSS (Ej: https://feeds.simplecast.com/...)" 
                    class="flex-grow p-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-primary focus:ring-1 transition duration-150"
                    value=""
                >
                <button 
                    id="load-button" 
                    class="px-6 py-3 bg-secondary text-white font-semibold rounded-xl hover:bg-gray-700 transition duration-150 shadow-md whitespace-nowrap"
                >
                    Cargar Podcast
                </button>
            </div>
            <div id="loading-message" class="hidden"></div>
        </div>

        <!-- Sección de Reproducción Actual (Ahora con Imagen) -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl mb-10 border-l-4 border-primary flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 items-center">
            
            <!-- Contenedor de la Imagen del Reproductor -->
            <div id="player-image-container" class="flex-shrink-0 w-32 h-32 md:w-40 md:h-40 bg-gray-200 rounded-xl overflow-hidden shadow-lg">
                <!-- Imagen por defecto se carga en JS -->
                <img src="https://placehold.co/100x100/4F46E5/FFFFFF?text=Podcast" class="player-cover opacity-50" alt="Cover Podcast">
            </div>

            <div class="flex-grow min-w-0">
                <h2 class="text-xl font-bold text-gray-900 mb-1">Reproduciendo Ahora:</h2>
                <p id="playing-title" class="text-xl text-gray-700 mb-3 font-semibold italic truncate">Selecciona un episodio de la lista inferior.</p>
                <p id="playing-source" class="text-xs text-gray-400 mb-3 truncate">Fuente: Ninguna</p>
                
                <audio id="audio-player" controls class="w-full rounded-lg" preload="none"></audio>
                <!-- Contenedor para mensajes de error de audio -->
                <div id="audio-error-container" class="hidden text-sm transition-all duration-300"></div> 
            </div>
        </div>

        <!-- Sección de Lista de Episodios -->
        <div class="flex items-center space-x-4 mb-6">
             <img id="podcast-cover-display" src="https://placehold.co/100x100/4F46E5/FFFFFF?text=Podcast" onerror="this.onerror=null;this.src='https://placehold.co/100x100/4F46E5/FFFFFF?text=Podcast';" class="podcast-cover rounded-lg shadow-md flex-shrink-0" alt="Podcast Cover">
            <div>
                <p class="text-lg text-gray-500 font-medium">Podcast:</p>
                <h2 id="podcast-title-display" class="text-3xl font-bold text-gray-800">Cargando...</h2>
            </div>
        </div>
       
        
        <div id="episodes-list" class="space-y-4">
            <!-- Los episodios se cargarán aquí -->
            <div class="p-6 text-center text-gray-500 bg-gray-100 rounded-xl">
                Ingresa y carga una URL de feed RSS para ver los episodios.
            </div>
        </div>
    </div>

</body>
</html>
